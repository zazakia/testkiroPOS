# Fastlane configuration for mobile POS app

default_platform(:ios)

platform :ios do
  desc "Build iOS app"
  lane :build do
    increment_build_number(xcodeproj: "ios/mobilepos.xcodeproj")
    build_app(
      workspace: "ios/mobilepos.xcworkspace",
      scheme: "mobilepos",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build/ios"
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    build
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      notify_external_testers: false
    )
  end

  desc "Deploy to App Store"
  lane :release do
    build
    upload_to_app_store(
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false
    )
  end

  desc "Run iOS tests"
  lane :test do
    run_tests(
      workspace: "ios/mobilepos.xcworkspace",
      scheme: "mobilepos",
      device: "iPhone 14"
    )
  end
end

platform :android do
  desc "Build Android app"
  lane :build do
    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "android/"
    )
  end

  desc "Deploy to Google Play Internal Testing"
  lane :beta do
    build
    upload_to_play_store(
      track: "internal",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Deploy to Google Play Production"
  lane :release do
    build
    upload_to_play_store(
      track: "production",
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
  end

  desc "Run Android tests"
  lane :test do
    gradle(
      task: "test",
      project_dir: "android/"
    )
  end
end

desc "Run all tests"
lane :test_all do
  ios.test
  android.test
end

desc "Build all platforms"
lane :build_all do
  ios.build
  android.build
end

desc "Deploy beta to all platforms"
lane :beta_all do
  ios.beta
  android.beta
end

desc "Deploy release to all platforms"
lane :release_all do
  ios.release
  android.release
end